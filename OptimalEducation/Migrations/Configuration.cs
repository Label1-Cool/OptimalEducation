namespace OptimalEducation.Migrations
{
    using Microsoft.AspNet.Identity;
    using Microsoft.AspNet.Identity.EntityFramework;
    using System;
    using System.Collections.Generic;
    using System.Data.Entity;
    using System.Data.Entity.Migrations;
    using System.Linq;
    using OptimalEducation.Models;

    public struct Role
    {
        public const string Admin = "Admin";
        public const string Entrant = "Entrant";
        public const string Faculty = "Faculty"; 
    }

    internal sealed class Configuration : DbMigrationsConfiguration<OptimalEducation.Models.ApplicationDbContext>
    {
        public Configuration()
        {
            AutomaticMigrationsEnabled = false;
        }

        protected override void Seed(OptimalEducation.Models.ApplicationDbContext context)
        {
            //  This method will be called after migrating to the latest version.
            var cities = new List<City>
            {
                new City { Id=1, Name = "Москва", Prestige = 90 },
                new City { Id=2, Name = "Санкт-Петербург", Prestige = 80 },
                new City { Id=3, Name = "Екатеринбург", Prestige = 60 }
            };
            cities.ForEach(s => context.Cities.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();

            var higherEducationInstitutions = new List<HigherEducationInstitution>
            {
                new HigherEducationInstitution { Id=1, Name = "МГУ", Prestige = 90, CityId=cities.Single(p=>p.Name=="Москва").Id, Type=HigherEducationInstitutionType.University},
                new HigherEducationInstitution { Id=2, Name = "СПбГУ", Prestige = 80, CityId=cities.Single(p=>p.Name=="Санкт-Петербург").Id, Type=HigherEducationInstitutionType.University  },
                new HigherEducationInstitution { Id=3, Name = "УРГУ", Prestige = 60, CityId=cities.Single(p=>p.Name=="Екатеринбург").Id, Type=HigherEducationInstitutionType.University }
            };
            higherEducationInstitutions.ForEach(s => context.HigherEducationInstitutions.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();

            var faculties = new List<Faculty>
            {
                new Faculty {Id=1, Name = "Кафедра МГУ1", Prestige = 90, HigherEducationInstitutionId=higherEducationInstitutions.Single(p=>p.Name=="МГУ").Id},
                new Faculty {Id=2, Name = "Кафедра СПбГУ1", Prestige = 80, HigherEducationInstitutionId=higherEducationInstitutions.Single(p=>p.Name=="СПбГУ").Id },
                new Faculty {Id=3, Name = "Кафедра УРГУ1", Prestige = 60, HigherEducationInstitutionId=higherEducationInstitutions.Single(p=>p.Name=="УРГУ").Id}
            };
            faculties.ForEach(s => context.Faculties.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();

            var clusters = new List<Cluster>
            {
                new Cluster { Id=1, Name = "Русский язык"},
                new Cluster { Id=2, Name = "Математика"},
                new Cluster { Id=3, Name = "Информатика"},
                new Cluster { Id=4, Name = "Физика"},
                new Cluster { Id=5, Name = "Химия"},
                new Cluster { Id=6, Name = "Английский язык"},
            };
            clusters.ForEach(s => context.Clusters.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();

            var disciplines = new List<ExamDiscipline>
            {
                new ExamDiscipline { Id=1, Name = "Русский язык"},
                new ExamDiscipline { Id=2, Name = "Математика"},
                new ExamDiscipline { Id=3, Name = "Информатика"},
                new ExamDiscipline { Id=4, Name = "Физика"},
                new ExamDiscipline { Id=5, Name = "Химия"},
                new ExamDiscipline { Id=6, Name = "Английский язык"},
            };
            disciplines.ForEach(s => context.ExamDisciplines.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();
            var schoolDiscipline = new List<SchoolDiscipline>
            {
                new SchoolDiscipline {Id=1, Name = "Русский язык"},
                new SchoolDiscipline {Id=2, Name = "Математика"},
                new SchoolDiscipline {Id=3, Name = "Информатика"},
                new SchoolDiscipline {Id=4, Name = "Физика"},
                new SchoolDiscipline {Id=5, Name = "Химия"},
                new SchoolDiscipline {Id=6, Name = "Английский язык"},
            };
            schoolDiscipline.ForEach(s => context.SchoolDisciplines.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();
            var olympiads = new List<Olympiad>
            {
                new Olympiad {Id=1, Name = "Русский язык"},
                new Olympiad {Id=2, Name = "Математика"},
                new Olympiad {Id=3, Name = "Информатика"},
                new Olympiad {Id=4, Name = "Физика"},
                new Olympiad {Id=5, Name = "Химия"},
                new Olympiad {Id=6, Name = "Английский язык"},
            };
            olympiads.ForEach(s => context.Olympiads.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();
            var sections = new List<Section>
            {
                new Section {Id=1, Name = "Бег"},
                new Section {Id=2, Name = "Матанир"},
                new Section {Id=3, Name = "Программир"},
                new Section {Id=4, Name = "Бомб"},
                new Section {Id=5, Name = "Азот"},
                new Section {Id=6, Name = "Инглишмен"},
            };
            sections.ForEach(s => context.Sections.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();
            var schoolTypes = new List<SchoolType>
            {
                new SchoolType {Id=1, Name = "Русский язык"},
                new SchoolType {Id=2, Name = "Математика"},
                new SchoolType {Id=3, Name = "Информатика"},
                new SchoolType {Id=4, Name = "Физика"},
                new SchoolType {Id=5, Name = "Химия"},
                new SchoolType {Id=6, Name = "Английский язык"},
            };
            schoolTypes.ForEach(s => context.SchoolTypes.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();

            var hobbies = new List<Hobbie>
            {
                new Hobbie {Id=1, Name = "Русский язык"},
                new Hobbie {Id=2, Name = "Математика"},
                new Hobbie {Id=3, Name = "Информатика"},
                new Hobbie {Id=4, Name = "Физика"},
                new Hobbie {Id=5, Name = "Химия"},
                new Hobbie {Id=6, Name = "Английский язык"},
            };
            hobbies.ForEach(s => context.Hobbies.AddOrUpdate(p => p.Name, s));
            context.SaveChanges();

            var weights = new List<Weight>
            {
                new Weight {Id=1, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Русский язык").Id,ExamDisciplineId=context.ExamDisciplines.Single(p=>p.Name=="Русский язык").Id},
                new Weight {Id=2, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,ExamDisciplineId=context.ExamDisciplines.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=3, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,ExamDisciplineId=context.ExamDisciplines.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=4, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,ExamDisciplineId=context.ExamDisciplines.Single(p=>p.Name=="Информатика").Id},
                new Weight {Id=5, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,ExamDisciplineId=context.ExamDisciplines.Single(p=>p.Name=="Информатика").Id},

                new Weight {Id=6, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Русский язык").Id,SchoolDisciplineId=context.SchoolDisciplines.Single(p=>p.Name=="Русский язык").Id},
                new Weight {Id=7, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.SchoolDisciplines.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=8, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.SchoolDisciplines.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=9, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.SchoolDisciplines.Single(p=>p.Name=="Информатика").Id},
                new Weight {Id=10, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.SchoolDisciplines.Single(p=>p.Name=="Информатика").Id},

                new Weight {Id=11, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Русский язык").Id,SchoolDisciplineId=context.Olympiads.Single(p=>p.Name=="Русский язык").Id},
                new Weight {Id=12, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.Olympiads.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=13, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.Olympiads.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=14, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.Olympiads.Single(p=>p.Name=="Информатика").Id},
                new Weight {Id=15, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.Olympiads.Single(p=>p.Name=="Информатика").Id},

                new Weight {Id=16, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Русский язык").Id,SchoolDisciplineId=context.Sections.Single(p=>p.Name=="Бег").Id},
                new Weight {Id=17, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.Sections.Single(p=>p.Name=="Матанир").Id},
                new Weight {Id=18, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.Sections.Single(p=>p.Name=="Матанир").Id},
                new Weight {Id=19, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.Sections.Single(p=>p.Name=="Программир").Id},
                new Weight {Id=20, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.Sections.Single(p=>p.Name=="Программир").Id},

                new Weight {Id=21, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Русский язык").Id,SchoolDisciplineId=context.SchoolTypes.Single(p=>p.Name=="Русский язык").Id},
                new Weight {Id=22, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.SchoolTypes.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=23, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.SchoolTypes.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=24, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.SchoolTypes.Single(p=>p.Name=="Информатика").Id},
                new Weight {Id=25, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.SchoolTypes.Single(p=>p.Name=="Информатика").Id},

                new Weight {Id=26, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Русский язык").Id,SchoolDisciplineId=context.Hobbies.Single(p=>p.Name=="Русский язык").Id},
                new Weight {Id=27, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.Hobbies.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=28, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.Hobbies.Single(p=>p.Name=="Математика").Id},
                new Weight {Id=29, Coefficient = 1, ClusterId = context.Clusters.Single(p=>p.Name=="Информатика").Id,SchoolDisciplineId=context.Hobbies.Single(p=>p.Name=="Информатика").Id},
                new Weight {Id=30, Coefficient = 0.7, ClusterId = context.Clusters.Single(p=>p.Name=="Математика").Id,SchoolDisciplineId=context.Hobbies.Single(p=>p.Name=="Информатика").Id},
            };
            weights.ForEach(s => context.Weights.AddOrUpdate(s));
            context.SaveChanges();

            CreateRoles(context);

            UserManager<ApplicationUser> UserManager = new UserManager<ApplicationUser>(new UserStore<ApplicationUser>(context));

            CreateAdminUser(UserManager);
            
            CreateEntrantUsers(UserManager);
            var user =UserManager.FindByName("Entrant1");
            foreach (var disc in context.ExamDisciplines)
            {
                if (!user.Entrant.UnitedStateExams.Any(p => p.Discipline == disc && p.EntrantId == user.Entrant.Id))
                user.Entrant.UnitedStateExams.Add(
                    new UnitedStateExam
                       {
                           Discipline = disc,
                           Entrant = user.Entrant,
                           Result=50,
                       });
            }
            foreach (var schoolDisc in context.SchoolDisciplines)
            {
                if (!user.Entrant.SchoolMarks.Any(p => p.SchoolDiscipline == schoolDisc && p.EntrantId == user.Entrant.Id))
                    user.Entrant.SchoolMarks.Add(
                        new SchoolMark
                        {
                            SchoolDiscipline = schoolDisc,
                            Entrant = user.Entrant,
                            Result = 4,
                        });
            }
            context.SaveChanges();

            CreateFacultyUsers(UserManager, faculties);
        }

        private void CreateRoles(OptimalEducation.Models.ApplicationDbContext context)
        {
            RoleManager<IdentityRole> RoleManager = new RoleManager<IdentityRole>(new
        RoleStore<IdentityRole>(context));
            //Create Role Admin if it does not exist
            if (!RoleManager.RoleExists(Role.Admin))
            {
                var roleresult = RoleManager.Create(new IdentityRole(Role.Admin));
            }
            if (!RoleManager.RoleExists(Role.Entrant))
            {
                var roleresult = RoleManager.Create(new IdentityRole(Role.Entrant));
            }
            if (!RoleManager.RoleExists(Role.Faculty))
            {
                var roleresult = RoleManager.Create(new IdentityRole(Role.Faculty));
            }
        }

        private void CreateAdminUser(UserManager<ApplicationUser> UserManager)
        {
            var user = new ApplicationUser();
            user.UserName = "Administrator";
            const string password = "password";

            if (UserManager.FindByName(user.UserName) == null)
            {
                var identityResult = UserManager.Create(user, password);

                if (identityResult.Succeeded)
                {
                    UserManager.AddToRole(user.Id, Role.Admin);
                }
            }
        }
        private void CreateEntrantUsers(UserManager<ApplicationUser> UserManager)
        {
            var user = new ApplicationUser();
            user.UserName = "Entrant1";
            const string password = "password";

            user.Entrant = new Entrant();
            if (UserManager.FindByName(user.UserName) == null)
            {
                var identityResult = UserManager.Create(user, password);

                if (identityResult.Succeeded)
                {
                    UserManager.AddToRole(user.Id, Role.Entrant);
                }
            }
        }
        private void CreateFacultyUsers(UserManager<ApplicationUser> UserManager, List<Faculty> higherEducationInstitutions)
        {
            var user = new ApplicationUser();
            user.UserName = "Faculty1";
            user.FacultyId = higherEducationInstitutions.First().Id;
            const string password = "password";

            if (UserManager.FindByName(user.UserName) == null)
            {
                var identityResult = UserManager.Create(user, password);

                if (identityResult.Succeeded)
                {
                    UserManager.AddToRole(user.Id, Role.Faculty);
                }
            }
        }
        private void CreateUniqueUserAndAddRole(UserManager<ApplicationUser> UserManager, ApplicationUser user, string password)
        {
            if (UserManager.FindByName(user.UserName) == null)
            {
                var identityResult = UserManager.Create(user, password);

                if (identityResult.Succeeded)
                {
                    UserManager.AddToRole(user.Id, Role.Admin);
                }
            }

        }
    }
}
